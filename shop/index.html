<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Shop • Raees Pharmacy</title>
<meta name="description" content="Shop OTC essentials at Raees Pharmacy. Call to order for pickup or free local delivery." />
<style>
  :root{
    --green:#16a34a; --blue:#0ea5e9; --ink:#1f2937; --muted:#6b7280;
    --soft:#f8fafc; --border:#e5e7eb;
  }
  *{box-sizing:border-box}
  html,body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:#fff}
  a{color:var(--green);text-decoration:none}
  header{background:var(--blue);color:#fff}
  .wrap{max-width:1160px;margin:0 auto;padding:16px 20px}
  .brand{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .brand h1{font-size:18px;margin:0}
  .btn-call{background:var(--green);color:#fff;padding:8px 12px;border-radius:8px;font-weight:700}
  main{background:var(--soft);min-height:70vh;padding:28px 0}
  h2{margin:0 0 6px}
  .sub{color:var(--muted);margin:0 0 18px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0 14px}
  .search{flex:1 1 260px; min-width:220px}
  .search input{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{border:1px solid var(--border);background:#fff;padding:7px 12px;border-radius:999px;cursor:pointer}
  .chip.active{background:var(--green);color:#fff;border-color:var(--green)}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
  .card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 8px 18px rgba(2,6,23,.06);display:flex;flex-direction:column}
  .img{width:100%;height:160px;border-radius:10px;background:#eef2f7;display:block;object-fit:contain}
  .title{margin:10px 0 6px;font-size:17px;font-weight:700}
  .muted{color:var(--muted)}
  .price-line{display:flex;justify-content:space-between;align-items:center;margin-top:auto;gap:10px}
  .cta{background:var(--green);color:#fff;border:none;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}
  .pill{font-size:12px;border:1px solid var(--border);border-radius:999px;padding:3px 8px;color:#64748b}
  .empty{background:#fff;border:1px dashed var(--border);border-radius:14px;padding:18px;text-align:center}
  footer{border-top:1px solid var(--border);padding:14px 0;color:var(--muted)}
  .pager{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:16px}
  .pager button{border:1px solid var(--border);background:#fff;padding:6px 10px;border-radius:8px;cursor:pointer}
  .pager button[disabled]{opacity:.5;cursor:not-allowed}
  @media (max-width: 960px){ .grid{grid-template-columns:1fr 1fr} }
  @media (max-width: 640px){ .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <div class="wrap brand">
    <h1>Raees Pharmacy — Shop</h1>
    <div style="display:flex;gap:10px;align-items:center">
      <a href="/" style="color:#fff">Home</a>
      <a class="btn-call" href="tel:+17188565998">Call 718-856-5998</a>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <h2>OTC Essentials</h2>
    <p class="sub">Browse our items below. To order, call for pickup or free local delivery (zone-based).</p>

    <div class="toolbar">
      <div class="search">
        <input id="q" type="search" placeholder="Search by name, SKU, or category…" />
      </div>
      <div id="chips" class="chips"></div>
    </div>

    <div id="grid" class="grid" aria-live="polite">
      <div class="card"><p class="muted">Loading products…</p></div>
    </div>

    <div class="pager" id="pager" hidden>
      <button id="prev">Prev</button>
      <span id="pageInfo" class="muted"></span>
      <button id="next">Next</button>
    </div>

    <p class="sub" id="note" style="margin-top:14px"></p>
  </div>
</main>

<footer>
  <div class="wrap">© <span id="y"></span> Raees Pharmacy • 750 Flatbush Ave, Brooklyn, NY 11226</div>
</footer>

<script>
  // Year
  document.getElementById('y').textContent = new Date().getFullYear();

  // CSV sources (tries either)
  const CSV_CANDIDATES = ["/products.csv.csv", "/products.csv"];

  // Parsing CSV with quoted commas
  function parseCSV(csv){
    const lines = csv.split(/\r?\n/);
    // remove empty line endings
    while(lines.length && !lines[lines.length-1].trim()) lines.pop();
    if(!lines.length) return {headers:[], rows:[]};

    const headers = splitCSVLine(lines.shift()).map(h=>h.trim());
    const rows = lines.map(line=>{
      const cols = splitCSVLine(line);
      const obj = {};
      headers.forEach((h,i)=>obj[h] = (cols[i] ?? "").trim());
      return obj;
    });
    return {headers, rows};
  }

  function splitCSVLine(line){
    const out=[], q='"'; let cur='', inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i], nx=line[i+1];
      if(ch===q && nx===q){ cur+=q; i++; continue; }
      if(ch===q){ inQ=!inQ; continue; }
      if(ch===',' && !inQ){ out.push(cur); cur=''; continue; }
      cur+=ch;
    }
    out.push(cur);
    return out;
  }

  // Helpers
  const money = v => {
    const n = Number(String(v).replace(/[^0-9.\-]/g,""));
    return Number.isFinite(n) ? "$"+n.toFixed(2) : "";
  };
  const norm = s => (s||"").toLowerCase();

  // State
  let ALL = [];         // all rows
  let VIEW = [];        // filtered rows
  let CATS = [];        // categories
  let page = 1, perPage = 18;

  // Mapping with fallbacks
  function pick(obj, list, fallbackIdx, headers){
    for(const key of list){
      if(obj[key] && obj[key].trim()) return obj[key].trim();
      const hk = headers.find(h=>h.toLowerCase()===key.toLowerCase());
      if(hk && obj[hk]) return obj[hk].trim();
    }
    const k = headers[fallbackIdx];
    return k ? (obj[k]||"").trim() : "";
  }

  function mapRow(obj, headers){
    return {
      sku:  pick(obj, ["sku","code","itemcode"], 0, headers),
      name: pick(obj, ["name","product","title","item"], 1, headers),
      category: pick(obj, ["category","dept","group"], 2, headers) || "Other",
      price: pick(obj, ["price","amount","retail"], 3, headers),
      qty:   pick(obj, ["qty","quantity","stock"], 4, headers),
      desc:  pick(obj, ["desc","description","details"], 5, headers),
      image: pick(obj, ["image","img","photo","picture"], 6, headers),
    };
  }

  function buildChips(){
    const chips = document.getElementById('chips');
    chips.innerHTML = '';
    const allBtn = chip("All", "all", true);
    chips.appendChild(allBtn);
    CATS.forEach(cat => chips.appendChild(chip(cat, cat)));
    function chip(label, value, active=false){
      const el = document.createElement('button');
      el.className = 'chip' + (active ? ' active' : '');
      el.textContent = label;
      el.dataset.value = value;
      el.onclick = () => {
        document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
        el.classList.add('active');
        page = 1;
        render();
      };
      return el;
    }
  }

  function card(p){
    const img = p.image || "https://via.placeholder.com/600x400?text=Product";
    const price = money(p.price);
    const sku = p.sku ? `<span class="pill">SKU: ${p.sku}</span>` : "";
    return `
      <div class="card" data-cat="${norm(p.category)}">
        <img class="img" src="${img}" alt="${p.name}">
        <div class="title">${p.name || "(No name)"}</div>
        ${p.desc ? `<p class="muted" style="margin:0 0 8px">${p.desc}</p>` : ""}
        <div class="muted" style="margin-bottom:8px">${sku} <span class="pill">${p.category}</span></div>
        <div class="price-line">
          <strong>${price}</strong>
          <a class="cta" href="tel:+17188565998">Call to order</a>
        </div>
      </div>
    `;
  }

  function render(){
    // Search
    const q = norm(document.getElementById('q').value);
    // Category
    const activeChip = document.querySelector('.chip.active');
    const cat = activeChip ? activeChip.dataset.value : 'all';

  // Filter (show EVERYTHING, even if qty <= 0) and normalize empty category to "Other"
VIEW = ALL
  .map(p => ({ ...p, category: (p.category && p.category.trim()) ? p.category : 'Other' }))
  .filter(p => {
    const hitSearch =
      !q ||
      norm(p.name).includes(q) ||
      norm(p.sku).includes(q) ||
      norm(p.category).includes(q);

    const hitCat = (cat === 'all') || (norm(p.category) === norm(cat));
    return hitSearch && hitCat;
  });


    // Pagination
    const total = VIEW.length;
    const start = (page-1)*perPage;
    const slice = VIEW.slice(start, start+perPage);

    const grid = document.getElementById('grid');
    grid.innerHTML = slice.length
      ? slice.map(card).join('')
      : `<div class="empty"><p>No matching products.</p></div>`;

    // Pager
    const pager = document.getElementById('pager');
    const prev = document.getElementById('prev');
    const next = document.getElementById('next');
    const info = document.getElementById('pageInfo');

    if(total > perPage){
      pager.hidden = false;
      prev.disabled = page<=1;
      next.disabled = page>=Math.ceil(total/perPage);
      info.textContent = `Page ${page} of ${Math.max(1, Math.ceil(total/perPage))} • ${total} items`;
    } else {
      pager.hidden = true;
    }
  }

  document.getElementById('prev').onclick = ()=>{ if(page>1){ page--; render(); } };
  document.getElementById('next').onclick = ()=>{
    const pages = Math.ceil(VIEW.length/perPage);
    if(page<pages){ page++; render(); }
  };
  document.getElementById('q').addEventListener('input', ()=>{
    page = 1; render();
  });

  (async ()=>{
    // Load CSV
    let csvText=null, used=null;
    for(const url of CSV_CANDIDATES){
      try{
        const r = await fetch(url, {cache:"no-store"});
        if(r.ok){ csvText = await r.text(); used = url; break; }
      }catch(e){}
    }
    const note = document.getElementById('note');
    if(!csvText){
      document.getElementById('grid').innerHTML =
        '<div class="empty"><p>Could not load products. Ensure products.csv or products.csv.csv exists in the repo root.</p></div>';
      return;
    }

    const {headers, rows} = parseCSV(csvText);
    if(!rows.length){
      document.getElementById('grid').innerHTML =
        '<div class="empty"><p>No products found in CSV.</p></div>';
      return;
    }

    // Map to normalized fields
    ALL = rows.map(r => mapRow(r, headers));

    // Build categories from data
    const set = new Set(ALL.map(p => (p.category || "Other").trim()).filter(Boolean));
    CATS = Array.from(set).sort((a,b)=>a.localeCompare(b));
    buildChips();

    // First render
    render();
    note.textContent = `Loaded ${ALL.length} products from ${used}. Update the CSV to change this page.`;
  })();
</script>
</body>
</html>
